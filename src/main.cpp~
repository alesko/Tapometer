/*********************************************************************
 *
 * Software License Agreement (BSD License)
 *
 *  Copyright (c) 2010, Alexander Skoglund, Karolinska Institute
 *  All rights reserved.
 *
 *  Redistribution and use in source and binary forms, with or without
 *  modification, are permitted provided that the following conditions
 *  are met:
 *
 *   * Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 *   * Redistributions in binary form must reproduce the above
 *     copyright notice, this list of conditions and the following
 *     disclaimer in the documentation and/or other materials provided
 *     with the distribution.
 *   * Neither the name of the Karolinska Institute nor the names of its
 *     contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 *  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 *  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 *  FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 *  COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 *  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 *  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 *  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
 *  ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *  POSSIBILITY OF SUCH DAMAGE.
 *
 *********************************************************************/


#include "labjack_u6tapometer.h"

TapoMeter *tap_counter;  // Global variable 


using namespace std;


void HandleKeyboard(unsigned char key,int x, int y)
{
  switch (key) {
  case '<':                           // Decrease multiplier
  case ',':
    tap_counter->decrease_k_();
    break;
  case '>':                           // Increase multiplier
  case '.':
    tap_counter->increase_k_();
    break;
  case '-':                           // Decrease threshold 
  case '_':
    tap_counter->decrease_c_();
    break;
  case '+':                           // Increase threshold 
  case '=':
    tap_counter->increase_c_();
    break;    
  case 27:                            // Quit
  case 'Q':
  case 'q':
    tap_counter->set_is_running(false);
    tap_counter->close_LJ_device();
    break;
  }
}


double GetRunTime(void)
{
   double sec = 0;
   struct timeval tp;

   gettimeofday(&tp,NULL);
   sec = tp.tv_sec + tp.tv_usec / 1000000.0;

   return(sec);
}


void HandleIdle(void)
{
   static double tstart = -1;
   double tstop;

   float fps = 100;
   if (tstart < 0)
      tstart = GetRunTime();
   tstop = GetRunTime();
   if (tstop - tstart > 1.0/fps) {
      glutPostRedisplay();
      tstart = tstop;
   }
}

void HandleReshape(int w,int h)
{
  tap_counter->set_screen_width(w);
  tap_counter->set_screen_height(h);
}

void IsRunning(void)
{
  
  if(tap_counter->get_is_running())
    tap_counter->SampleData();
  else
    {      
      exit(0);
    }

}



int main(int argc, char *argv[])
{

  // Initialize the LabJack device
  tap_counter = new TapoMeter(640,480);

  // Set up GLUT environment
  glutInit(&argc,argv);
  glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGB | GLUT_DEPTH);
  glutCreateWindow("Tapometer");
  glutReshapeWindow(tap_counter->get_screen_width(),tap_counter->get_screen_height());
  glutReshapeFunc(HandleReshape);
  glutDisplayFunc(IsRunning);
  glutKeyboardFunc(HandleKeyboard);
  glutIdleFunc(HandleIdle);
  glutMainLoop();

  return(0);

}

